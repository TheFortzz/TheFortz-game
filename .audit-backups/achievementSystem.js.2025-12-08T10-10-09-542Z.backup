/**
 * Achievement System for TheFortz
 * Track player accomplishments with rewards and progression
 */

const AchievementSystem = {
  achievements: {
    // Combat Achievements
    FIRST_BLOOD: {
      id: 'first_blood',
      name: 'First Blood',
      description: 'Get your first kill',
      icon: 'ðŸŽ¯',
      category: 'combat',
      rarity: 'common',
      requirement: { kills: 1 },
      reward: { fortz: 50, xp: 100 }
    },
    KILLING_SPREE: {
      id: 'killing_spree',
      name: 'Killing Spree',
      description: 'Get 5 kills without dying',
      icon: 'ðŸ”¥',
      category: 'combat',
      rarity: 'uncommon',
      requirement: { killStreak: 5 },
      reward: { fortz: 200, xp: 500 }
    },
    UNSTOPPABLE: {
      id: 'unstoppable',
      name: 'Unstoppable',
      description: 'Get 10 kills without dying',
      icon: 'âš¡',
      category: 'combat',
      rarity: 'rare',
      requirement: { killStreak: 10 },
      reward: { fortz: 500, xp: 1000 }
    },
    SHARPSHOOTER: {
      id: 'sharpshooter',
      name: 'Sharpshooter',
      description: 'Achieve 80% accuracy in a match',
      icon: 'ðŸŽª',
      category: 'combat',
      rarity: 'rare',
      requirement: { accuracy: 0.8 },
      reward: { fortz: 300, xp: 750 }
    },
    HEADHUNTER: {
      id: 'headhunter',
      name: 'Headhunter',
      description: 'Get 100 total kills',
      icon: 'ðŸ’€',
      category: 'combat',
      rarity: 'epic',
      requirement: { totalKills: 100 },
      reward: { fortz: 1000, xp: 2000 }
    },

    // Survival Achievements
    SURVIVOR: {
      id: 'survivor',
      name: 'Survivor',
      description: 'Survive for 10 minutes in a match',
      icon: 'ðŸ›¡ï¸',
      category: 'survival',
      rarity: 'common',
      requirement: { survivalTime: 600000 },
      reward: { fortz: 100, xp: 200 }
    },
    UNTOUCHABLE: {
      id: 'untouchable',
      name: 'Untouchable',
      description: 'Win a match without taking damage',
      icon: 'âœ¨',
      category: 'survival',
      rarity: 'legendary',
      requirement: { winNoDamage: true },
      reward: { fortz: 2000, xp: 5000 }
    },

    // Game Mode Achievements
    FFA_CHAMPION: {
      id: 'ffa_champion',
      name: 'FFA Champion',
      description: 'Win 10 Free For All matches',
      icon: 'ðŸ‘‘',
      category: 'gamemode',
      rarity: 'rare',
      requirement: { ffaWins: 10 },
      reward: { fortz: 500, xp: 1500 }
    },
    TEAM_PLAYER: {
      id: 'team_player',
      name: 'Team Player',
      description: 'Win 5 Team Deathmatch games',
      icon: 'ðŸ¤',
      category: 'gamemode',
      rarity: 'uncommon',
      requirement: { tdmWins: 5 },
      reward: { fortz: 300, xp: 800 }
    },

    // Collection Achievements
    COLLECTOR: {
      id: 'collector',
      name: 'Collector',
      description: 'Collect 100 power-ups',
      icon: 'ðŸ“¦',
      category: 'collection',
      rarity: 'uncommon',
      requirement: { powerUpsCollected: 100 },
      reward: { fortz: 250, xp: 600 }
    },
    HOARDER: {
      id: 'hoarder',
      name: 'Hoarder',
      description: 'Collect 500 power-ups',
      icon: 'ðŸ’Ž',
      category: 'collection',
      rarity: 'epic',
      requirement: { powerUpsCollected: 500 },
      reward: { fortz: 1500, xp: 3000 }
    },

    // Progression Achievements
    ROOKIE: {
      id: 'rookie',
      name: 'Rookie',
      description: 'Reach level 5',
      icon: 'ðŸŒ±',
      category: 'progression',
      rarity: 'common',
      requirement: { level: 5 },
      reward: { fortz: 100, xp: 0 }
    },
    VETERAN: {
      id: 'veteran',
      name: 'Veteran',
      description: 'Reach level 25',
      icon: 'â­',
      category: 'progression',
      rarity: 'rare',
      requirement: { level: 25 },
      reward: { fortz: 1000, xp: 0 }
    },
    LEGEND: {
      id: 'legend',
      name: 'Legend',
      description: 'Reach level 50',
      icon: 'ðŸ‘‘',
      category: 'progression',
      rarity: 'legendary',
      requirement: { level: 50 },
      reward: { fortz: 5000, xp: 0 }
    },

    // Special Achievements
    SPEED_DEMON: {
      id: 'speed_demon',
      name: 'Speed Demon',
      description: 'Travel 100km total distance',
      icon: 'ðŸ’¨',
      category: 'special',
      rarity: 'uncommon',
      requirement: { distanceTraveled: 100000 },
      reward: { fortz: 400, xp: 900 }
    },
    RICH: {
      id: 'rich',
      name: 'Rich',
      description: 'Earn 10,000 Fortz',
      icon: 'ðŸ’°',
      category: 'special',
      rarity: 'epic',
      requirement: { fortzEarned: 10000 },
      reward: { fortz: 2000, xp: 4000 }
    },
    DEDICATED: {
      id: 'dedicated',
      name: 'Dedicated',
      description: 'Play for 10 hours total',
      icon: 'â°',
      category: 'special',
      rarity: 'rare',
      requirement: { playTime: 36000000 },
      reward: { fortz: 800, xp: 2000 }
    }
  },

  // Player achievement progress
  playerProgress: {},

  // Initialize player achievements
  initPlayer(playerId) {
    if (!this.playerProgress[playerId]) {
      this.playerProgress[playerId] = {
        unlocked: [],
        progress: {},
        stats: {
          kills: 0,
          deaths: 0,
          totalKills: 0,
          killStreak: 0,
          bestKillStreak: 0,
          wins: 0,
          ffaWins: 0,
          tdmWins: 0,
          powerUpsCollected: 0,
          distanceTraveled: 0,
          fortzEarned: 0,
          playTime: 0,
          accuracy: 0,
          shotsHit: 0,
          shotsFired: 0
        }
      };
    }
  },

  // Update player stats
  updateStats(playerId, stats) {
    this.initPlayer(playerId);
    Object.assign(this.playerProgress[playerId].stats, stats);
    this.checkAchievements(playerId);
  },

  // Check if player unlocked any achievements
  checkAchievements(playerId) {
    const player = this.playerProgress[playerId];
    if (!player) return [];

    const newlyUnlocked = [];

    Object.values(this.achievements).forEach((achievement) => {
      // Skip if already unlocked
      if (player.unlocked.includes(achievement.id)) return;

      // Check requirements
      if (this.meetsRequirements(player.stats, achievement.requirement)) {
        player.unlocked.push(achievement.id);
        newlyUnlocked.push(achievement);
      }
    });

    return newlyUnlocked;
  },

  meetsRequirements(stats, requirements) {
    return Object.entries(requirements).every(([key, value]) => {
      if (typeof value === 'boolean') {
        return stats[key] === value;
      }
      return stats[key] >= value;
    });
  },

  // Get achievement progress
  getProgress(playerId, achievementId) {
    const achievement = this.achievements[achievementId.toUpperCase()];
    if (!achievement) return null;

    const player = this.playerProgress[playerId];
    if (!player) return null;

    const requirement = achievement.requirement;
    const reqKey = Object.keys(requirement)[0];
    const reqValue = requirement[reqKey];
    const currentValue = player.stats[reqKey] || 0;

    return {
      current: currentValue,
      required: reqValue,
      percentage: Math.min(100, currentValue / reqValue * 100),
      unlocked: player.unlocked.includes(achievement.id)
    };
  },

  // Get all achievements for player
  getPlayerAchievements(playerId) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    return Object.values(this.achievements).map((achievement) => ({
      ...achievement,
      unlocked: player.unlocked.includes(achievement.id),
      progress: this.getProgress(playerId, achievement.id)
    }));
  },

  // Get achievements by category
  getByCategory(category) {
    return Object.values(this.achievements).filter((a) => a.category === category);
  },

  // Get achievements by rarity
  getByRarity(rarity) {
    return Object.values(this.achievements).filter((a) => a.rarity === rarity);
  },

  // Award achievement manually
  awardAchievement(playerId, achievementId) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];
    const achievement = this.achievements[achievementId.toUpperCase()];

    if (!achievement || player.unlocked.includes(achievement.id)) {
      return null;
    }

    player.unlocked.push(achievement.id);
    return achievement;
  },

  // Get completion percentage
  getCompletionPercentage(playerId) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];
    const total = Object.keys(this.achievements).length;
    const unlocked = player.unlocked.length;
    return unlocked / total * 100;
  }
};

// Export
if (typeof window !== 'undefined') {
  window.AchievementSystem = AchievementSystem;
}