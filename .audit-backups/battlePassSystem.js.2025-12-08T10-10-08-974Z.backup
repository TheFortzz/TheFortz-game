/**
 * Battle Pass System for TheFortz
 * Seasonal progression with free and premium tiers
 */

const BattlePassSystem = {
  // Current season
  currentSeason: {
    number: 1,
    name: 'Season 1: Rise of Tanks',
    startDate: Date.now(),
    endDate: Date.now() + 90 * 24 * 60 * 60 * 1000, // 90 days
    theme: 'military'
  },

  // Battle pass tiers (100 levels)
  tiers: [],

  // Player progress
  playerProgress: {},

  // Initialize battle pass
  init() {
    this.generateTiers();
  },

  // Generate 100 tiers of rewards
  generateTiers() {
    this.tiers = [];

    for (let level = 1; level <= 100; level++) {
      const tier = {
        level: level,
        xpRequired: this.calculateXPRequired(level),
        freeRewards: this.generateFreeRewards(level),
        premiumRewards: this.generatePremiumRewards(level)
      };

      this.tiers.push(tier);
    }
  },

  calculateXPRequired(level) {
    // Exponential growth
    return Math.floor(1000 * Math.pow(1.05, level - 1));
  },

  generateFreeRewards(level) {
    const rewards = [];

    // Every level: Fortz
    rewards.push({
      type: 'fortz',
      amount: 50 + level * 10
    });

    // Every 5 levels: Tank skin
    if (level % 5 === 0) {
      rewards.push({
        type: 'tankSkin',
        id: `bp_s1_tank_${level}`,
        rarity: level >= 50 ? 'epic' : 'rare'
      });
    }

    // Every 10 levels: Emote
    if (level % 10 === 0) {
      rewards.push({
        type: 'emote',
        id: `bp_s1_emote_${level}`
      });
    }

    // Milestone rewards
    if (level === 25) {
      rewards.push({ type: 'spray', id: 'bp_s1_spray_25' });
    }
    if (level === 50) {
      rewards.push({ type: 'weaponSkin', id: 'bp_s1_weapon_50' });
    }
    if (level === 100) {
      rewards.push({ type: 'tankSkin', id: 'bp_s1_legendary_100', rarity: 'legendary' });
    }

    return rewards;
  },

  generatePremiumRewards(level) {
    const rewards = [];

    // Every level: More Fortz
    rewards.push({
      type: 'fortz',
      amount: 100 + level * 20
    });

    // Every 3 levels: Premium items
    if (level % 3 === 0) {
      rewards.push({
        type: 'tankSkin',
        id: `bp_s1_premium_tank_${level}`,
        rarity: level >= 75 ? 'legendary' : level >= 50 ? 'epic' : 'rare'
      });
    }

    // Every 5 levels: Weapon skin
    if (level % 5 === 0) {
      rewards.push({
        type: 'weaponSkin',
        id: `bp_s1_premium_weapon_${level}`,
        rarity: level >= 50 ? 'epic' : 'rare'
      });
    }

    // Exclusive milestone rewards
    if (level === 1) {
      rewards.push({ type: 'emote', id: 'bp_s1_premium_welcome' });
    }
    if (level === 50) {
      rewards.push({ type: 'tankSkin', id: 'bp_s1_premium_50', rarity: 'legendary' });
    }
    if (level === 100) {
      rewards.push({ type: 'tankSkin', id: 'bp_s1_ultimate', rarity: 'legendary' });
      rewards.push({ type: 'spray', id: 'bp_s1_master' });
    }

    return rewards;
  },

  // Initialize player
  initPlayer(playerId) {
    if (!this.playerProgress[playerId]) {
      this.playerProgress[playerId] = {
        level: 1,
        xp: 0,
        hasPremium: false,
        claimedRewards: [],
        purchaseDate: null
      };
    }
  },

  // Add XP to player
  addXP(playerId, amount) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    player.xp += amount;

    const levelsGained = [];

    // Check for level ups
    while (player.level < 100) {
      const currentTier = this.tiers[player.level - 1];
      if (player.xp >= currentTier.xpRequired) {
        player.xp -= currentTier.xpRequired;
        player.level++;
        levelsGained.push(player.level);
      } else {
        break;
      }
    }

    return {
      currentLevel: player.level,
      currentXP: player.xp,
      levelsGained: levelsGained,
      nextLevelXP: player.level < 100 ? this.tiers[player.level - 1].xpRequired : 0
    };
  },

  // Purchase premium pass
  purchasePremium(playerId, fortzCost = 1000) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    if (player.hasPremium) {
      return { success: false, error: 'Already owns premium' };
    }

    player.hasPremium = true;
    player.purchaseDate = Date.now();

    return {
      success: true,
      cost: fortzCost,
      unlockedRewards: this.getUnlockedPremiumRewards(playerId)
    };
  },

  // Get unlocked premium rewards
  getUnlockedPremiumRewards(playerId) {
    const player = this.playerProgress[playerId];
    if (!player || !player.hasPremium) return [];

    const rewards = [];
    for (let i = 0; i < player.level; i++) {
      rewards.push(...this.tiers[i].premiumRewards);
    }

    return rewards;
  },

  // Claim reward
  claimReward(playerId, level, isPremium = false) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    if (level > player.level) {
      return { success: false, error: 'Level not reached' };
    }

    if (isPremium && !player.hasPremium) {
      return { success: false, error: 'Premium required' };
    }

    const rewardKey = `${level}_${isPremium ? 'premium' : 'free'}`;
    if (player.claimedRewards.includes(rewardKey)) {
      return { success: false, error: 'Already claimed' };
    }

    const tier = this.tiers[level - 1];
    const rewards = isPremium ? tier.premiumRewards : tier.freeRewards;

    player.claimedRewards.push(rewardKey);

    return {
      success: true,
      rewards: rewards
    };
  },

  // Get player progress
  getProgress(playerId) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    const currentTier = this.tiers[player.level - 1];
    const nextTier = player.level < 100 ? this.tiers[player.level] : null;

    return {
      season: this.currentSeason,
      level: player.level,
      xp: player.xp,
      xpToNextLevel: currentTier ? currentTier.xpRequired - player.xp : 0,
      hasPremium: player.hasPremium,
      daysRemaining: Math.ceil((this.currentSeason.endDate - Date.now()) / (24 * 60 * 60 * 1000)),
      currentTier: currentTier,
      nextTier: nextTier
    };
  },

  // Get all available rewards
  getAllRewards(playerId) {
    this.initPlayer(playerId);
    const player = this.playerProgress[playerId];

    return this.tiers.map((tier) => ({
      level: tier.level,
      unlocked: tier.level <= player.level,
      freeRewards: tier.freeRewards,
      premiumRewards: tier.premiumRewards,
      freeClaimed: player.claimedRewards.includes(`${tier.level}_free`),
      premiumClaimed: player.claimedRewards.includes(`${tier.level}_premium`)
    }));
  },

  // Reset for new season
  newSeason(seasonNumber, seasonName, theme) {
    this.currentSeason = {
      number: seasonNumber,
      name: seasonName,
      startDate: Date.now(),
      endDate: Date.now() + 90 * 24 * 60 * 60 * 1000,
      theme: theme
    };

    // Reset all player progress
    Object.keys(this.playerProgress).forEach((playerId) => {
      this.playerProgress[playerId] = {
        level: 1,
        xp: 0,
        hasPremium: false,
        claimedRewards: [],
        purchaseDate: null
      };
    });

    this.generateTiers();
  }
};

// Initialize on load
if (typeof window !== 'undefined') {
  window.BattlePassSystem = BattlePassSystem;
  BattlePassSystem.init();
}